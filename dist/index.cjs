"use strict";var ge=Object.defineProperty;var i=(e,t)=>ge(e,"name",{value:t,configurable:!0});var pe=require("node:events"),F=require("node:util"),I=require("node:path"),P=require("node:fs"),U=require("node:os"),ye=require("expect");let b=!0;const w=typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{};let T=0;if(w.process&&w.process.env&&w.process.stdout){const{FORCE_COLOR:e,NODE_DISABLE_COLORS:t,NO_COLOR:s,TERM:o,COLORTERM:r}=w.process.env;t||s||e==="0"?b=!1:e==="1"||e==="2"||e==="3"?b=!0:o==="dumb"?b=!1:"CI"in w.process.env&&["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(n=>n in w.process.env)?b=!0:b=process.stdout.isTTY,b&&(process.platform==="win32"||r&&(r==="truecolor"||r==="24bit")?T=3:o&&(o.endsWith("-256color")||o.endsWith("256"))?T=2:T=1)}let Y={enabled:b,supportLevel:T};function E(e,t,s=1){const o=`\x1B[${e}m`,r=`\x1B[${t}m`,n=new RegExp(`\\x1b\\[${t}m`,"g");return u=>Y.enabled&&Y.supportLevel>=s?o+(""+u).replace(n,o)+r:""+u}i(E,"kolorist");const p=E(2,22),R=E(31,39),C=E(32,39),K=E(33,39),W=i(e=>Number.isFinite(e)?e:0,"toZeroIfInfinity");function be(e){return{days:Math.trunc(e/864e5),hours:Math.trunc(e/36e5%24),minutes:Math.trunc(e/6e4%60),seconds:Math.trunc(e/1e3%60),milliseconds:Math.trunc(e%1e3),microseconds:Math.trunc(W(e*1e3)%1e3),nanoseconds:Math.trunc(W(e*1e6)%1e3)}}i(be,"parseNumber");function Se(e){return{days:e/86400000n,hours:e/3600000n%24n,minutes:e/60000n%60n,seconds:e/1000n%60n,milliseconds:e%1000n,microseconds:0n,nanoseconds:0n}}i(Se,"parseBigint");function we(e){switch(typeof e){case"number":{if(Number.isFinite(e))return be(e);break}case"bigint":return Se(e)}throw new TypeError("Expected a finite number or bigint")}i(we,"parseMilliseconds");const Te=i(e=>e===0||e===0n,"isZero"),$e=i((e,t)=>t===1||t===1n?e:`${e}s`,"pluralize"),Ee=1e-7,ke=24n*60n*60n*1000n;function M(e,t){const s=typeof e=="bigint";if(!s&&!Number.isFinite(e))throw new TypeError("Expected a finite number or bigint");t={...t};const o=e<0?"-":"";e=e<0?-e:e,t.colonNotation&&(t.compact=!1,t.formatSubMilliseconds=!1,t.separateMilliseconds=!1,t.verbose=!1),t.compact&&(t.unitCount=1,t.secondsDecimalDigits=0,t.millisecondsDecimalDigits=0);let r=[];const n=i((l,h)=>{const g=Math.floor(l*10**h+Ee);return(Math.round(g)/10**h).toFixed(h)},"floorDecimals"),u=i((l,h,g,d)=>{if(!((r.length===0||!t.colonNotation)&&Te(l)&&!(t.colonNotation&&g==="m"))){if(d??=String(l),t.colonNotation){const S=d.includes(".")?d.split(".")[0].length:d.length,$=r.length>0?2:1;d="0".repeat(Math.max(0,$-S))+d}else d+=t.verbose?" "+$e(h,l):g;r.push(d)}},"add"),c=we(e),a=BigInt(c.days);if(t.hideYearAndDays?u(BigInt(a)*24n+BigInt(c.hours),"hour","h"):(t.hideYear?u(a,"day","d"):(u(a/365n,"year","y"),u(a%365n,"day","d")),u(Number(c.hours),"hour","h")),u(Number(c.minutes),"minute","m"),!t.hideSeconds)if(t.separateMilliseconds||t.formatSubMilliseconds||!t.colonNotation&&e<1e3&&!t.subSecondsAsDecimals){const l=Number(c.seconds),h=Number(c.milliseconds),g=Number(c.microseconds),d=Number(c.nanoseconds);if(u(l,"second","s"),t.formatSubMilliseconds)u(h,"millisecond","ms"),u(g,"microsecond","\xB5s"),u(d,"nanosecond","ns");else{const S=h+g/1e3+d/1e6,$=typeof t.millisecondsDecimalDigits=="number"?t.millisecondsDecimalDigits:0,me=S>=1?Math.round(S):Math.ceil(S),J=$?S.toFixed($):me;u(Number.parseFloat(J),"millisecond","ms",J)}}else{const l=(s?Number(e%ke):e)/1e3%60,h=typeof t.secondsDecimalDigits=="number"?t.secondsDecimalDigits:1,g=n(l,h),d=t.keepDecimalsOnWholeSeconds?g:g.replace(/\.0+$/,"");u(Number.parseFloat(d),"second","s",d)}if(r.length===0)return o+"0"+(t.verbose?" milliseconds":"ms");const f=t.colonNotation?":":" ";return typeof t.unitCount=="number"&&(r=r.slice(0,Math.max(t.unitCount,1))),o+r.join(f)}i(M,"prettyMilliseconds");const y=`
`,De="    ",{log:O,error:k}=console,Ne=C("\u2714"),Le=R("\u2716"),Ae=K("\u2022"),Fe=p("\u25CB"),j=i(()=>{const e=new Date,t=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0"),o=String(e.getSeconds()).padStart(2,"0");return p(`${t}:${s}:${o}`)},"formatTimestamp"),G=i(({startTime:e,timeout:t,endTime:s})=>{const o=(s||Date.now())-e;let r=M(o);return t&&(r+=` / ${M(t)}`),o<50?"":` ${p(`(${r})`)}`},"prettyDuration"),Ie=i(e=>e.replaceAll(/^/gm,De),"indentMultiline"),_=i((e,t=!0)=>{const{title:s,attempt:o,retry:r}=e;let n=`${s+G(e)}`;return t&&r>1&&(n+=p(` (${o}/${r})`)),n},"getTestTitle"),q=i((e,t,s)=>{let o=`${j()} ${Le} ${_(e)}`;s&&(o+=` [${s}]`),k(o),k(`${Ie(F.inspect(t))}
`)},"logTestFail"),Pe=i(e=>{O(`${j()} ${Ne} ${_(e)}`)},"logTestSuccess"),Z=i(e=>{O(`${j()} ${Fe} ${_(e,!1)}`)},"logTestSkip"),Re=i(e=>{if(e.length===0)return;const t=[];let s=0,o=0,r=0,n,u;for(const a of e)a.startTime&&(!n||n>a.startTime)&&(n=a.startTime),a.endTime===void 0?t.push(a):((!u||u<a.endTime)&&(u=a.endTime),a.error?o+=1:a.skip?r+=1:s+=1);let c="";if(t.length>0){for(const a of t)c+=`${y}${Ae} ${a.title+G(a)}`;c+=y}c+=`${y}${p(M((u??Date.now())-n))}`,c+=y+(s>0?C:p)(`${s.toLocaleString()} passed`),o>0&&(c+=y+R(`${o.toLocaleString()} failed`)),r>0&&(c+=y+p(`${r.toLocaleString()} skipped`)),t.length>0&&(c+=y+K(`${t.length.toLocaleString()} pending`)),c+=y,O(c)},"logReport"),Me=i(()=>{let e,t;const s=new Promise((o,r)=>{e=o,t=r});return Object.assign(s,{resolve:e,reject:t})},"createDeferred"),Oe=i((e,t)=>{const s=Me(),o=setTimeout(()=>{const r=new Error(`Timeout: ${e}ms`);t?.abort(r),s.reject(r)},e);return Object.assign(s,{timeoutId:o})},"setTimer"),Q=i((e,t,s)=>{if(!e||!("then"in e)||t===void 0||t===0)return e;const o=Oe(t,s);return Promise.race([e,o]).finally(()=>{clearTimeout(o.timeoutId)})},"timeLimitFunction"),X=i(e=>{const t=[];return{addHook:i(r=>{t.push(r)},"addHook"),runHooks:i(async(...r)=>{for(const n of t)try{await n(...r)}catch(u){await e(u)}},"runHooks")}},"createHook"),je=i(async(e,t)=>{for(let s=1;s<=t;s+=1)try{await e(s);return}catch(o){if(s===t)throw o}},"retry"),_e=i((e,t)=>{if(t instanceof Map)return{$type:"Map",entries:Array.from(t.entries()).sort(([s],[o])=>{const r=String(s),n=String(o);return r<n?-1:r>n?1:0})};if(t instanceof Set)return{$type:"Set",values:Array.from(t).sort((s,o)=>{const r=String(s),n=String(o);return r<n?-1:r>n?1:0})};if(typeof t=="bigint")return`${t}n`;if(t===void 0)return"$undefined";if(typeof t=="function")return`[Function: ${t.name||"anonymous"}]`;if(typeof t=="symbol"||t instanceof RegExp)return t.toString();if(t instanceof Date)return t.toISOString();if(t instanceof Error)return{$type:"Error",name:t.name,message:t.message,stack:t.stack?.split(`
`)[0]||""};if(t instanceof Uint8Array)return{$type:t.constructor.name,data:Array.from(t)};if(t&&typeof t=="object"){const s=Object.prototype.toString.call(t);if(s!=="[object Object]"&&s!=="[object Array]"&&s!=="[object Date]"&&s!=="[object RegExp]"&&s!=="[object Error]")return s}return t},"snapshotReplacer"),H=i((e,t=new Set)=>{if(!e||typeof e!="object"||e instanceof Date||e instanceof RegExp||e instanceof Error||e instanceof Map||e instanceof Set||e instanceof Uint8Array)return e;if(t.has(e))return"[Circular]";if(t.add(e),Array.isArray(e)){const r=Array.from({length:e.length});for(let n=0;n<e.length;n+=1)n in e&&(r[n]=H(e[n],t));return t.delete(e),r}const s={},o=Object.keys(e).sort();for(const r of o)s[r]=H(e[r],t);return t.delete(e),s},"sortObjectKeys"),qe=i(e=>{try{const t=H(e),s=JSON.stringify(t,_e);return JSON.parse(s)}catch(t){return t instanceof Error&&t.message.includes("circular")?"[Circular Reference]":`[Serialization Error: ${t}]`}},"serializeValue"),He=i(e=>{const t=Array.from(e.keys()).sort(),s={};for(const o of t)s[o]=e.get(o);return JSON.stringify(s,null,2)},"formatSnapshotFile"),Be=i(e=>{if(e.length===0)return"";let t=0,s=0;for(const{summary:r}of e)t+=r.new,s+=r.updated;const o=[];return t>0&&o.push(`\u{1F4F8} ${t} new`),s>0&&o.push(`\u270F\uFE0F ${s} updated`),o.length>0?`
Snapshots: ${o.join(", ")}`:""},"formatSnapshotSummary");let m;const D=new Set,N=new Set,B=new Set,x=new Set,L=new Map,xe=new Set,ee=new Map;let te=!1,z=process.env.MANTEN_SNAPSHOT_PATH||".manten.snap";const ze=process.env.MANTEN_UPDATE_SNAPSHOTS==="1"||process.env.MANTEN_UPDATE_SNAPSHOTS==="true",Ve=i(()=>{if(m===void 0)try{const e=I.resolve(z),t=P.readFileSync(e,"utf8"),s=JSON.parse(t);m=new Map;for(const o in s)m.set(o,s[o])}catch{m=new Map}},"loadSnapshots"),ve=i((e,t,s,o)=>{m===void 0&&Ve();const r=ee.get(e);if(r!==void 0&&r!==o)throw new Error(`Duplicate test title detected: "${e}". Test titles must be unique across all files when using global snapshots.`);L.has(e)||(L.set(e,0),ee.set(e,o),xe.add(e));let n;if(s)n=s;else{const a=L.get(e)+1;L.set(e,a),n=`${e} ${a}`}if(D.has(n)||N.has(n)||x.has(n)||B.has(n))throw new Error(`Duplicate snapshot key: "${n}". Test names must be unique across all test files.`);const u=qe(t);if(!m.has(n)){m.set(n,u),D.add(n);return}const c=m.get(n);if(F.isDeepStrictEqual(u,c))x.add(n);else if(ze)m.set(n,u),N.add(n);else throw B.add(n),new Error(`Snapshot mismatch for "${n}"
Expected: ${se(c)}
Received: ${se(u)}`)},"matchSnapshot"),se=i(e=>F.format("%O",e),"format"),Je=i(()=>{if(D.size===0&&N.size===0||!m)return;const e=I.resolve(z),t=I.dirname(e);te||(P.mkdirSync(t,{recursive:!0}),te=!0);const s=He(m);P.writeFileSync(e,s,"utf8")},"saveSnapshots"),Ue=i(()=>({new:D.size,updated:N.size,failed:B.size,passed:x.size}),"getSummary");process.on("exit",()=>{try{Je();const e=Ue();if(e.new>0||e.updated>0){const t=Be([{file:"global",summary:e}]);t&&process.stdout.write(`${t}
`)}}catch(e){process.stderr.write(`Failed to save snapshots: ${e}
`)}});const Ye=i(e=>{if(e.snapshotPath!==void 0&&m!==void 0)throw new Error("configure() must be called before any snapshot tests are run. Snapshots have already been loaded from the default location. Please ensure configure() is called at the beginning of your test suite.");e.snapshotPath!==void 0&&(z=e.snapshotPath)},"configure");class ne extends Error{static{i(this,"SkipError")}constructor(t){super(t||"Test skipped"),this.name="SkipError"}}const re=i(e=>(e&&typeof e=="object"&&"matcherResult"in e&&e.constructor.name==="JestAssertionError"&&delete e.matcherResult,e),"patchJestAssertionError"),oe=i(async(e,t)=>{const{testFunction:s,timeout:o}=e,r=X(c=>{q(e,c,"onTestFail")}),n=i(async c=>{await r.runHooks(c)},"handleError"),u=X(async c=>{q(e,re(c),"onTestFinish")});try{await je(async c=>{e.attempt=c,e.startTime=Date.now();const a=new AbortController;let f;t&&(f=i(()=>{a.signal.aborted||a.abort(t.abortController.signal.reason)},"handleParentAbort"),t.abortController.signal.addEventListener("abort",f),t.abortController.signal.aborted&&f());try{await Q(s({signal:a.signal,onTestFail:r.addHook,onTestFinish:u.addHook,skip:i(l=>{throw new ne(l)},"skip"),expectSnapshot:i((l,h)=>{ve(e.title,l,h,e)},"expectSnapshot")}),o,a),Pe(e)}catch(l){if(l instanceof ne)e.skip=!0,Z(e);else throw q(e,re(l)),await n(l),l}finally{t&&f&&t.abortController.signal.removeEventListener("abort",f),a.signal.aborted||a.abort(),await u.runHooks(),e.endTime=Date.now()}},e.retry)}catch(c){e.error=c,process.exitCode=1}},"runTest"),ie=[];process.on("exit",()=>{Re(ie)});const A=process.env.TESTONLY;A&&console.log(p(`Only running tests that match: ${JSON.stringify(A)}
`));const ce=i((e,t)=>((s,o,r)=>{if(e&&(s=`${e} ${s}`),t&&(t.testsStarted=!0),A&&!s.includes(A))return Promise.resolve();const n={title:s,testFunction:o,retry:1};if(r!==void 0&&(typeof r=="number"?n.timeout=r:(n.timeout=r?.timeout,r?.retry&&(n.retry=r?.retry))),ie.push(n),t?.skipped){n.skip=!0,n.skipReason=t.skipReason;const u=Date.now();return n.startTime=u,n.endTime=u,Z(n),Promise.resolve()}return(async()=>{const c=i(async()=>{if(t?.concurrencyLimiter){const a=await t.concurrencyLimiter.acquire();try{await oe(n,t)}finally{a()}}else await oe(n,t)},"executeTest")();t&&t.pendingTests.push(c),await c})()}),"createTest"),Ce=i(async e=>{for(;e.length>0;){const t=e.splice(0);await Promise.all(t)}},"waitAllPromises"),Ke=i(e=>("default"in e&&(e=e.default),"default"in e&&(e=e.default),e),"unwrapModule"),V=i(e=>{let t=typeof e=="number"?e:ae(),s=0;const o=[];let r;return e==="auto"&&(r=setInterval(()=>{const a=ae();if(a!==t)for(t=a;o.length>0&&s<t;){const f=o.shift();f&&(s+=1,f())}},5e3),r.unref()),{acquire:i(()=>s<t?(s+=1,Promise.resolve(()=>{s-=1;const a=o.shift();a&&(s+=1,a())})):new Promise(a=>{o.push(()=>{a(()=>{s-=1;const f=o.shift();f&&(s+=1,f())})})}),"acquire"),setLimit:i(a=>{for(t=a;o.length>0&&s<t;){const f=o.shift();f&&(s+=1,f())}},"setLimit"),cleanup:i(()=>{r&&clearInterval(r)},"cleanup")}},"createSemaphore"),ae=i(()=>{const e=U.cpus().length,t=U.loadavg()[0];return Math.max(1,Math.min(Math.floor(e*(1-Math.min(t/e,.8))),e))},"calculateAutoLimit"),ue=i((e,t)=>((s,o,r)=>(e&&(s=`${e} ${s}`),t&&(t.testsStarted=!0),(async()=>{const n=v(s,r?.parallel,r?.timeout);await i(async()=>{if(t?.concurrencyLimiter){const c=await t.concurrencyLimiter.acquire();try{await n.run(o,t)}finally{c()}}else await n.run(o,t)},"executeDescribe")()})())),"createDescribe"),fe=i((e,t)=>((s,...o)=>{t&&(t.testsStarted=!0);const r=i(()=>{const n=v(e);return n.run(async()=>Ke(await s).apply(n,o),t)},"executeTestSuite");return t?.concurrencyLimiter?t.concurrencyLimiter.acquire().then(n=>r().finally(n)):r()}),"createRunTestSuite"),le=ce(),de=ue(),he=fe(),v=i((e,t,s)=>{let o;t!==void 0&&(t===!0?o=void 0:t===!1?o=V(1):typeof t=="number"?o=V(t):t==="auto"&&(o=V("auto")));const r=new AbortController;pe.setMaxListeners(0,r.signal);const n={pendingTests:[],callbacks:{onFinish:[]},concurrencyLimiter:o,abortController:r,timeout:s,skipped:!1,skipReason:void 0,testsStarted:!1,run:i(async(u,c)=>{c?.skipped&&(n.skipped=!0,n.skipReason=c.skipReason);let a;c&&(a=i(()=>{r.signal.aborted||r.abort(c.abortController.signal.reason)},"handleParentAbort"),c.abortController.signal.addEventListener("abort",a),c.abortController.signal.aborted&&a());try{const f=(async()=>{await u(n.api),await Ce(n.pendingTests)})();c&&c.pendingTests.push(f),await Q(f,s,r)}catch(f){k(f),process.exitCode=1}finally{c&&a&&c.abortController.signal.removeEventListener("abort",a),r.signal.aborted||r.abort(),o&&o.cleanup();for(const f of n.callbacks.onFinish)try{await f()}catch(l){k(l),process.exitCode=1}}},"run")};return n.api={signal:r.signal,test:e?ce(`${e} \u203A`,n):le,describe:e?ue(`${e} \u203A`,n):de,runTestSuite:e?fe(e,n):he,onFinish:i(u=>{n.callbacks.onFinish.push(u)},"onFinish"),skip:i(u=>{if(n.testsStarted)throw new Error("skip() must be called before any tests or nested describes run. Move skip() to the beginning of the describe callback.");n.skipped=!0,n.skipReason=u},"skip")},n},"createContext"),We=v(),Ge=i((e,t,s)=>{const o=typeof e=="string"?e:void 0,r=typeof e=="string"?t:e,n=typeof e=="string"?s:void 0;return i(async function(...c){const a=this||We;o?await a.api.describe(o,f=>r(f,...c),n):await r(a.api,...c)},"testSuiteWrapper")},"testSuite"),Ze=i(e=>{setTimeout(()=>{process.exitCode=1,console.error(R(`\u2716 Process timed out after ${e}ms`)),setImmediate(()=>process.exit(1))},e).unref()},"setProcessTimeout");Object.defineProperty(exports,"expect",{enumerable:!0,get:i(function(){return ye.expect},"get")}),exports.configure=Ye,exports.describe=de,exports.runTestSuite=he,exports.setProcessTimeout=Ze,exports.test=le,exports.testSuite=Ge;
