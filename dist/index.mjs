var K=Object.defineProperty;var r=(e,t)=>K(e,"name",{value:t,configurable:!0});import{inspect as Q}from"node:util";import x from"node:os";import{expect as Se}from"expect";let y=!0;const w=typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{};let b=0;if(w.process&&w.process.env&&w.process.stdout){const{FORCE_COLOR:e,NODE_DISABLE_COLORS:t,NO_COLOR:n,TERM:s,COLORTERM:o}=w.process.env;t||n||e==="0"?y=!1:e==="1"||e==="2"||e==="3"?y=!0:s==="dumb"?y=!1:"CI"in w.process.env&&["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(i=>i in w.process.env)?y=!0:y=process.stdout.isTTY,y&&(process.platform==="win32"||o&&(o==="truecolor"||o==="24bit")?b=3:s&&(s.endsWith("-256color")||s.endsWith("256"))?b=2:b=1)}let R={enabled:y,supportLevel:b};function D(e,t,n=1){const s=`\x1B[${e}m`,o=`\x1B[${t}m`,i=new RegExp(`\\x1b\\[${t}m`,"g");return c=>R.enabled&&R.supportLevel>=n?s+(""+c).replace(i,s)+o:""+c}r(D,"kolorist");const L=D(2,22),v=D(31,39),M=D(32,39),A=D(33,39),B=r(e=>Number.isFinite(e)?e:0,"toZeroIfInfinity");function X(e){return{days:Math.trunc(e/864e5),hours:Math.trunc(e/36e5%24),minutes:Math.trunc(e/6e4%60),seconds:Math.trunc(e/1e3%60),milliseconds:Math.trunc(e%1e3),microseconds:Math.trunc(B(e*1e3)%1e3),nanoseconds:Math.trunc(B(e*1e6)%1e3)}}r(X,"parseNumber");function ee(e){return{days:e/86400000n,hours:e/3600000n%24n,minutes:e/60000n%60n,seconds:e/1000n%60n,milliseconds:e%1000n,microseconds:0n,nanoseconds:0n}}r(ee,"parseBigint");function te(e){switch(typeof e){case"number":{if(Number.isFinite(e))return X(e);break}case"bigint":return ee(e)}throw new TypeError("Expected a finite number or bigint")}r(te,"parseMilliseconds");const ne=r(e=>e===0||e===0n,"isZero"),se=r((e,t)=>t===1||t===1n?e:`${e}s`,"pluralize"),oe=1e-7,ce=24n*60n*60n*1000n;function I(e,t){const n=typeof e=="bigint";if(!n&&!Number.isFinite(e))throw new TypeError("Expected a finite number or bigint");t={...t};const s=e<0?"-":"";e=e<0?-e:e,t.colonNotation&&(t.compact=!1,t.formatSubMilliseconds=!1,t.separateMilliseconds=!1,t.verbose=!1),t.compact&&(t.unitCount=1,t.secondsDecimalDigits=0,t.millisecondsDecimalDigits=0);let o=[];const i=r((h,d)=>{const m=Math.floor(h*10**d+oe);return(Math.round(m)/10**d).toFixed(d)},"floorDecimals"),c=r((h,d,m,l)=>{if(!((o.length===0||!t.colonNotation)&&ne(h)&&!(t.colonNotation&&m==="m"))){if(l??=String(h),t.colonNotation){const T=l.includes(".")?l.split(".")[0].length:l.length,p=o.length>0?2:1;l="0".repeat(Math.max(0,p-T))+l}else l+=t.verbose?" "+se(d,h):m;o.push(l)}},"add"),a=te(e),u=BigInt(a.days);if(t.hideYearAndDays?c(BigInt(u)*24n+BigInt(a.hours),"hour","h"):(t.hideYear?c(u,"day","d"):(c(u/365n,"year","y"),c(u%365n,"day","d")),c(Number(a.hours),"hour","h")),c(Number(a.minutes),"minute","m"),!t.hideSeconds)if(t.separateMilliseconds||t.formatSubMilliseconds||!t.colonNotation&&e<1e3&&!t.subSecondsAsDecimals){const h=Number(a.seconds),d=Number(a.milliseconds),m=Number(a.microseconds),l=Number(a.nanoseconds);if(c(h,"second","s"),t.formatSubMilliseconds)c(d,"millisecond","ms"),c(m,"microsecond","\xB5s"),c(l,"nanosecond","ns");else{const T=d+m/1e3+l/1e6,p=typeof t.millisecondsDecimalDigits=="number"?t.millisecondsDecimalDigits:0,z=T>=1?Math.round(T):Math.ceil(T),F=p?T.toFixed(p):z;c(Number.parseFloat(F),"millisecond","ms",F)}}else{const h=(n?Number(e%ce):e)/1e3%60,d=typeof t.secondsDecimalDigits=="number"?t.secondsDecimalDigits:1,m=i(h,d),l=t.keepDecimalsOnWholeSeconds?m:m.replace(/\.0+$/,"");c(Number.parseFloat(l),"second","s",l)}if(o.length===0)return s+"0"+(t.verbose?" milliseconds":"ms");const f=t.colonNotation?":":" ";return typeof t.unitCount=="number"&&(o=o.slice(0,Math.max(t.unitCount,1))),s+o.join(f)}r(I,"prettyMilliseconds");const g=`
`,re="    ",{log:k,error:$}=console,ie=M("\u2714"),ae=v("\u2716"),ue=A("\u2022"),P=r(({startTime:e,timeout:t,endTime:n})=>{const s=(n||Date.now())-e;let o=I(s);return t&&(o+=` / ${I(t)}`),s<50?"":` ${L(`(${o})`)}`},"prettyDuration"),le=r(e=>e.replaceAll(/^/gm,re),"indentMultiline"),_=r(e=>{const{title:t,attempt:n,retry:s}=e;let o=`${t+P(e)}`;return s>1&&(o+=L(` (${n}/${s})`)),o},"getTestTitle"),N=r((e,t,n)=>{let s=`${ae} ${_(e)}`;n&&(s+=` [${n}]`),$(s),$(`${le(Q(t))}
`)},"logTestFail"),fe=r(e=>{k(`${ie} ${_(e)}`)},"logTestSuccess"),de=r(e=>{if(e.length===0)return;const t=[];let n=0,s=0,o,i;for(const a of e)a.startTime&&(!o||o>a.startTime)&&(o=a.startTime),a.endTime===void 0?t.push(a):((!i||i<a.endTime)&&(i=a.endTime),a.error?s+=1:n+=1);let c="";if(t.length>0){for(const a of t)c+=`${g}${ue} ${a.title+P(a)}`;c+=g}c+=`${g}${L(I((i??Date.now())-o))}`,c+=g+(n>0?M:L)(`${n.toLocaleString()} passed`),s>0&&(c+=g+v(`${s.toLocaleString()} failed`)),t.length>0&&(c+=g+A(`${t.length.toLocaleString()} pending`)),c+=g,k(c)},"logReport"),me=r(()=>{let e,t;const n=new Promise((s,o)=>{e=s,t=o});return Object.assign(n,{resolve:e,reject:t})},"createDeferred"),he=r(e=>{const t=me(),n=setTimeout(()=>t.reject(new Error(`Timeout: ${e}ms`)),e);return Object.assign(t,{timeoutId:n})},"setTimer"),ye=r((e,t)=>{if(!e||!("then"in e)||t===void 0||t===0)return e;const n=he(t);return Promise.race([e,n]).finally(()=>{clearTimeout(n.timeoutId)})},"timeLimitFunction"),H=r(e=>{const t=[];return{addHook:r(o=>{t.push(o)},"addHook"),runHooks:r(async(...o)=>{for(const i of t)try{await i(...o)}catch(c){await e(c)}},"runHooks")}},"createHook"),ge=r(async(e,t)=>{for(let n=1;n<=t;n+=1)try{await e(n);return}catch(s){if(n===t)throw s}},"retry"),O=r(e=>(e&&typeof e=="object"&&"matcherResult"in e&&e.constructor.name==="JestAssertionError"&&delete e.matcherResult,e),"patchJestAssertionError"),C=r(async e=>{const{testFunction:t,timeout:n}=e,s=H(c=>{N(e,c,"onTestFail")}),o=r(async c=>{await s.runHooks(c)},"handleError"),i=H(async c=>{N(e,O(c),"onTestFinish")});try{await ge(async c=>{e.attempt=c,e.startTime=Date.now();try{await ye(t({onTestFail:s.addHook,onTestFinish:i.addHook}),n)}catch(a){throw N(e,O(a)),await o(a),a}finally{await i.runHooks(),e.endTime=Date.now()}fe(e)},e.retry)}catch(c){e.error=c,process.exitCode=1}},"runTest"),j=[];process.on("exit",()=>{de(j)});const q=process.env.TESTONLY,V=r((e,t)=>(async(n,s,o)=>{if(e&&(n=`${e} ${n}`),q&&!n.includes(q))return;const i={title:n,testFunction:s,retry:1};o!==void 0&&(typeof o=="number"?i.timeout=o:(i.timeout=o?.timeout,o?.retry&&(i.retry=o?.retry))),j.push(i);const a=r(async()=>{if(t?.concurrencyLimiter){const u=await t.concurrencyLimiter.acquire();try{await C(i)}finally{u()}}else await C(i)},"executeTest")();t&&t.pendingTests.push(a),await a}),"createTest"),Te=r(async e=>{for(;e.length>0;){const t=e.splice(0);await Promise.all(t)}},"waitAllPromises"),we=r(e=>("default"in e&&(e=e.default),"default"in e&&(e=e.default),e),"unwrapModule"),S=r(e=>{let t=typeof e=="number"?e:Y(),n=0;const s=[];let o;return e==="auto"&&(o=setInterval(()=>{const u=Y();if(u!==t)for(t=u;s.length>0&&n<t;){const f=s.shift();f&&(n+=1,f())}},5e3),o.unref()),{acquire:r(()=>n<t?(n+=1,Promise.resolve(()=>{n-=1;const u=s.shift();u&&(n+=1,u())})):new Promise(u=>{s.push(()=>{u(()=>{n-=1;const f=s.shift();f&&(n+=1,f())})})}),"acquire"),setLimit:r(u=>{for(t=u;s.length>0&&n<t;){const f=s.shift();f&&(n+=1,f())}},"setLimit"),cleanup:r(()=>{o&&clearInterval(o)},"cleanup")}},"createSemaphore"),Y=r(()=>{const e=x.cpus().length,t=x.loadavg()[0];return Math.max(1,Math.min(Math.floor(e*(1-Math.min(t/e,.8))),e))},"calculateAutoLimit"),W=r((e,t)=>(async(n,s,o)=>{e&&(n=`${e} ${n}`);const i=E(n,o?.parallel);await r(async()=>{if(t?.concurrencyLimiter){const a=await t.concurrencyLimiter.acquire();try{await i.run(s,t)}finally{a()}}else await i.run(s,t)},"executeDescribe")()}),"createDescribe"),G=r((e,t)=>((n,...s)=>{const o=r(()=>{const i=E(e);return i.run(async()=>we(await n).apply(i,s),t)},"executeTestSuite");return t?.concurrencyLimiter?t.concurrencyLimiter.acquire().then(i=>o().finally(i)):o()}),"createRunTestSuite"),U=V(),J=W(),Z=G(),E=r((e,t)=>{let n;t!==void 0&&(t===!0?n=void 0:t===!1?n=S(1):typeof t=="number"?n=S(t):t==="auto"&&(n=S("auto")));const s={pendingTests:[],callbacks:{onFinish:[]},concurrencyLimiter:n,run:r(async(o,i)=>{try{const c=(async()=>{await o(s.api),await Te(s.pendingTests)})();i&&i.pendingTests.push(c),await c}catch(c){$(c),process.exitCode=1}finally{n&&n.cleanup();for(const c of s.callbacks.onFinish)try{await c()}catch(a){$(a),process.exitCode=1}}},"run")};return s.api={test:e?V(`${e} \u203A`,s):U,describe:e?W(`${e} \u203A`,s):J,runTestSuite:e?G(e,s):Z,onFinish:r(o=>{s.callbacks.onFinish.push(o)},"onFinish")},s},"createContext"),be=E(),pe=r((e,t,n)=>{const s=typeof e=="string"?e:void 0,o=typeof e=="string"?t:e,i=typeof e=="string"?n:void 0;return r(async function(...a){const u=this||be;s?await u.api.describe(s,f=>o(f,...a),i):await o(u.api,...a)},"testSuiteWrapper")},"testSuite");export{J as describe,Se as expect,Z as runTestSuite,U as test,pe as testSuite};
