import{expect as J}from"expect";let f=!0;const h=typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{};let T=0;if(h.process&&h.process.env&&h.process.stdout){const{FORCE_COLOR:t,NODE_DISABLE_COLORS:e,NO_COLOR:n,TERM:i,COLORTERM:r}=h.process.env;e||n||t==="0"?f=!1:t==="1"||t==="2"||t==="3"?f=!0:i==="dumb"?f=!1:"CI"in h.process.env&&["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(s=>s in h.process.env)?f=!0:f=process.stdout.isTTY,f&&(process.platform==="win32"||r&&(r==="truecolor"||r==="24bit")?T=3:i&&(i.endsWith("-256color")||i.endsWith("256"))?T=2:T=1)}let b={enabled:f,supportLevel:T};function p(t,e,n=1){const i=`\x1B[${t}m`,r=`\x1B[${e}m`,s=new RegExp(`\\x1b\\[${e}m`,"g");return o=>b.enabled&&b.supportLevel>=n?i+(""+o).replace(s,i)+r:""+o}const g=p(2,22),D=p(31,39),$=p(32,39),x=p(33,39);function _(t){if(typeof t!="number")throw new TypeError("Expected a number");const e=t>0?Math.floor:Math.ceil;return{days:e(t/864e5),hours:e(t/36e5)%24,minutes:e(t/6e4)%60,seconds:e(t/1e3)%60,milliseconds:e(t)%1e3,microseconds:e(t*1e3)%1e3,nanoseconds:e(t*1e6)%1e3}}const A=(t,e)=>e===1?t:`${t}s`,P=1e-7;function y(t,e={}){if(!Number.isFinite(t))throw new TypeError("Expected a finite number");e.colonNotation&&(e.compact=!1,e.formatSubMilliseconds=!1,e.separateMilliseconds=!1,e.verbose=!1),e.compact&&(e.secondsDecimalDigits=0,e.millisecondsDecimalDigits=0);const n=[],i=(o,c)=>{const a=Math.floor(o*10**c+P);return(Math.round(a)/10**c).toFixed(c)},r=(o,c,a,l)=>{if((n.length===0||!e.colonNotation)&&o===0&&!(e.colonNotation&&a==="m"))return;l=(l||o||"0").toString();let m,u;if(e.colonNotation){m=n.length>0?":":"",u="";const L=l.includes(".")?l.split(".")[0].length:l.length,S=n.length>0?2:1;l="0".repeat(Math.max(0,S-L))+l}else m="",u=e.verbose?" "+A(c,o):a;n.push(m+l+u)},s=_(t);if(r(Math.trunc(s.days/365),"year","y"),r(s.days%365,"day","d"),r(s.hours,"hour","h"),r(s.minutes,"minute","m"),e.separateMilliseconds||e.formatSubMilliseconds||!e.colonNotation&&t<1e3)if(r(s.seconds,"second","s"),e.formatSubMilliseconds)r(s.milliseconds,"millisecond","ms"),r(s.microseconds,"microsecond","\xB5s"),r(s.nanoseconds,"nanosecond","ns");else{const o=s.milliseconds+s.microseconds/1e3+s.nanoseconds/1e6,c=typeof e.millisecondsDecimalDigits=="number"?e.millisecondsDecimalDigits:0,a=o>=1?Math.round(o):Math.ceil(o),l=c?o.toFixed(c):a;r(Number.parseFloat(l),"millisecond","ms",l)}else{const o=t/1e3%60,c=typeof e.secondsDecimalDigits=="number"?e.secondsDecimalDigits:1,a=i(o,c),l=e.keepDecimalsOnWholeSeconds?a:a.replace(/\.0+$/,"");r(Number.parseFloat(l),"second","s",l)}if(n.length===0)return"0"+(e.verbose?" milliseconds":"ms");if(e.compact)return n[0];if(typeof e.unitCount=="number"){const o=e.colonNotation?"":" ";return n.slice(0,Math.max(e.unitCount,1)).join(o)}return e.colonNotation?n.join(""):n.join(" ")}const d=`
`,{log:E,error:w}=console,V=$("\u2714"),B=D("\u2716"),j=x("\u2022"),I=({startTime:t,timeout:e,endTime:n})=>{const i=(n||Date.now())-t;let r=y(i);return e&&(r+=` / ${y(e)}`),i<50?"":` ${g(`(${r})`)}`},k=t=>{const{title:e,error:n}=t;(n?w:E)(`${n?B:V} ${e+I(t)}`)},v=t=>{if(t.length===0)return;const e=[];let n=0,i=0,r,s;for(const c of t)c.startTime&&(!r||r>c.startTime)&&(r=c.startTime),c.endTime===void 0?e.push(c):((!s||s<c.endTime)&&(s=c.endTime),c.error?i+=1:n+=1);let o="";if(e.length>0){for(const c of e)o+=`${d}${j} ${c.title+I(c)}`;o+=d}o+=`${d}${g(y(s-r))}`,o+=d+(n>0?$:g)(`${n.toLocaleString()} passed`),i>0&&(o+=d+D(`${i.toLocaleString()} failed`)),e.length>0&&(o+=d+x(`${e.length.toLocaleString()} pending`)),o+=d,E(o)},G=async(t,e)=>new Promise((n,i)=>{e.timeoutId=setTimeout(()=>{i(new Error(`Timeout: ${t}ms`))},t)}),U=async t=>{const{testFunction:e,timeout:n}=t,i={onTestFail:[],onTestFinish:[]},r={onTestFail(s){i.onTestFail.push(s)},onTestFinish(s){i.onTestFinish.push(s)}};t.startTime=Date.now();try{if(n){const s={timeoutId:void 0};try{await Promise.race([e(r),G(n,s)])}finally{clearTimeout(s.timeoutId)}}else await e(r)}catch(s){t.error=s,s&&typeof s=="object"&&"matcherResult"in s&&s.constructor.name==="JestAssertionError"&&delete s.matcherResult,w(s),process.exitCode=1;for(const o of i.onTestFail)await o(s)}finally{t.endTime=Date.now(),k(t);for(const s of i.onTestFinish)await s()}},O=[];process.on("exit",()=>{v(O)});function F(t,e){return async function(i,r,s){t&&(i=`${t} ${i}`);const o={title:i,testFunction:r,timeout:s};O.push(o);const c=U(o);e&&e.push(c),await c}}async function W(t){for(;t.length>0;){const e=t.splice(0);await Promise.all(e)}}function N(t,e){return async function(i,r){t&&(i=`${t} ${i}`);const s=[];try{const o=(async()=>{const c={test:F(`${i} \u203A`,s),describe:N(`${i} \u203A`,s),runTestSuite:(a,...l)=>{const m=(async()=>{let u=await a;return"default"in u&&(u=u.default),"default"in u&&(u=u.default),u.apply(c,l)})();return s.push(m),m}};await r(c),await W(s)})();e&&e.push(o),await o}catch(o){w(o),process.exitCode=1}}}const R=F(),C=N(),M={describe:C,test:R,runTestSuite:async(t,...e)=>{let n=await t;return"default"in n&&(n=n.default),"default"in n&&(n=n.default),n.apply(M,e)}};function Y(t){return function(...e){return t(this||M,...e)}}export{C as describe,J as expect,R as test,Y as testSuite};
