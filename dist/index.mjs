import{expect as Q}from"expect";let u=!0;const d=typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{};let h=0;if(d.process&&d.process.env&&d.process.stdout){const{FORCE_COLOR:t,NODE_DISABLE_COLORS:e,NO_COLOR:n,TERM:c,COLORTERM:o}=d.process.env;e||n||t==="0"?u=!1:t==="1"||t==="2"||t==="3"?u=!0:c==="dumb"?u=!1:"CI"in d.process.env&&["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(i=>i in d.process.env)?u=!0:u=process.stdout.isTTY,u&&(process.platform==="win32"||o&&(o==="truecolor"||o==="24bit")?h=3:c&&(c.endsWith("-256color")||c.endsWith("256"))?h=2:h=1)}let D={enabled:u,supportLevel:h};function T(t,e,n=1){const c=`\x1B[${t}m`,o=`\x1B[${e}m`,i=new RegExp(`\\x1b\\[${e}m`,"g");return s=>D.enabled&&D.supportLevel>=n?c+(""+s).replace(i,c)+o:""+s}const w=T(2,22),x=T(31,39),$=T(32,39),F=T(33,39);function M(t){if(typeof t!="number")throw new TypeError("Expected a number");const e=t>0?Math.floor:Math.ceil;return{days:e(t/864e5),hours:e(t/36e5)%24,minutes:e(t/6e4)%60,seconds:e(t/1e3)%60,milliseconds:e(t)%1e3,microseconds:e(t*1e3)%1e3,nanoseconds:e(t*1e6)%1e3}}const k=(t,e)=>e===1?t:`${t}s`,V=1e-7;function y(t,e={}){if(!Number.isFinite(t))throw new TypeError("Expected a finite number");e.colonNotation&&(e.compact=!1,e.formatSubMilliseconds=!1,e.separateMilliseconds=!1,e.verbose=!1),e.compact&&(e.secondsDecimalDigits=0,e.millisecondsDecimalDigits=0);const n=[],c=(s,r)=>{const a=Math.floor(s*10**r+V);return(Math.round(a)/10**r).toFixed(r)},o=(s,r,a,l)=>{if((n.length===0||!e.colonNotation)&&s===0&&!(e.colonNotation&&a==="m"))return;l=(l||s||"0").toString();let g,p;if(e.colonNotation){g=n.length>0?":":"",p="";const A=l.includes(".")?l.split(".")[0].length:l.length,P=n.length>0?2:1;l="0".repeat(Math.max(0,P-A))+l}else g="",p=e.verbose?" "+k(r,s):a;n.push(g+l+p)},i=M(t);if(o(Math.trunc(i.days/365),"year","y"),o(i.days%365,"day","d"),o(i.hours,"hour","h"),o(i.minutes,"minute","m"),e.separateMilliseconds||e.formatSubMilliseconds||!e.colonNotation&&t<1e3)if(o(i.seconds,"second","s"),e.formatSubMilliseconds)o(i.milliseconds,"millisecond","ms"),o(i.microseconds,"microsecond","\xB5s"),o(i.nanoseconds,"nanosecond","ns");else{const s=i.milliseconds+i.microseconds/1e3+i.nanoseconds/1e6,r=typeof e.millisecondsDecimalDigits=="number"?e.millisecondsDecimalDigits:0,a=s>=1?Math.round(s):Math.ceil(s),l=r?s.toFixed(r):a;o(Number.parseFloat(l),"millisecond","ms",l)}else{const s=t/1e3%60,r=typeof e.secondsDecimalDigits=="number"?e.secondsDecimalDigits:1,a=c(s,r),l=e.keepDecimalsOnWholeSeconds?a:a.replace(/\.0+$/,"");o(Number.parseFloat(l),"second","s",l)}if(n.length===0)return"0"+(e.verbose?" milliseconds":"ms");if(e.compact)return n[0];if(typeof e.unitCount=="number"){const s=e.colonNotation?"":" ";return n.slice(0,Math.max(e.unitCount,1)).join(s)}return e.colonNotation?n.join(""):n.join(" ")}const f=`
`,{log:E,error:m}=console,B=$("\u2714"),j=x("\u2716"),v=F("\u2022"),I=({startTime:t,timeout:e,endTime:n})=>{const c=(n||Date.now())-t;let o=y(c);return e&&(o+=` / ${y(e)}`),c<50?"":` ${w(`(${o})`)}`},G=t=>{const{title:e,error:n}=t;(n?m:E)(`${n?j:B} ${e+I(t)}`)},U=t=>{if(t.length===0)return;const e=[];let n=0,c=0,o,i;for(const r of t)r.startTime&&(!o||o>r.startTime)&&(o=r.startTime),r.endTime===void 0?e.push(r):((!i||i<r.endTime)&&(i=r.endTime),r.error?c+=1:n+=1);let s="";if(e.length>0){for(const r of e)s+=`${f}${v} ${r.title+I(r)}`;s+=f}s+=`${f}${w(y(i-o))}`,s+=f+(n>0?$:w)(`${n.toLocaleString()} passed`),c>0&&(s+=f+x(`${c.toLocaleString()} failed`)),e.length>0&&(s+=f+F(`${e.length.toLocaleString()} pending`)),s+=f,E(s)},W=async(t,e)=>new Promise((n,c)=>{e.timeoutId=setTimeout(()=>{c(new Error(`Timeout: ${t}ms`))},t)}),Y=async t=>{const{testFunction:e,timeout:n}=t,c={onTestFail:[],onTestFinish:[]},o={onTestFail(s){c.onTestFail.push(s)},onTestFinish(s){c.onTestFinish.push(s)}},i=async s=>{s&&typeof s=="object"&&"matcherResult"in s&&s.constructor.name==="JestAssertionError"&&delete s.matcherResult,m(s),process.exitCode=1;for(const r of c.onTestFail)try{await r(s)}catch(a){m("[onTestFail]",t.title),m(a)}return s};t.startTime=Date.now();try{if(n){const s={timeoutId:void 0};try{await Promise.race([e(o),W(n,s)])}finally{clearTimeout(s.timeoutId)}}else await e(o)}catch(s){t.error=await i(s)}finally{for(const s of c.onTestFinish)try{await s()}catch(r){const a=await i(r);t.error||(t.error=a)}t.endTime=Date.now(),G(t)}},O=[];process.on("exit",()=>{U(O)});const R=(t,e)=>async(n,c,o)=>{t&&(n=`${t} ${n}`);const i={title:n,testFunction:c,timeout:o};O.push(i);const s=Y(i);e&&e.pendingTests.push(s),await s},z=t=>("default"in t&&(t=t.default),"default"in t&&(t=t.default),t),N=(t,e)=>(n,...c)=>{const o=b(t);return o.run(async()=>z(await n).apply(o,c),e)},H=async t=>{for(;t.length>0;){const e=t.splice(0);await Promise.all(e)}},b=t=>{const e={pendingTests:[],callbacks:{onFinish:[]},run:async(n,c)=>{try{const o=(async()=>{await n(e.api),await H(e.pendingTests)})();c&&c.pendingTests.push(o),await o}catch(o){m(o),process.exitCode=1}finally{for(const o of e.callbacks.onFinish)try{await o()}catch(i){m(i),process.exitCode=1}}}};return e.api={test:t?R(`${t} \u203A`,e):L,describe:t?C(`${t} \u203A`,e):S,runTestSuite:t?N(t,e):_,onFinish:n=>{e.callbacks.onFinish.push(n)}},e},C=(t,e)=>async(n,c)=>{t&&(n=`${t} ${n}`),await b(n).run(c,e)},L=R(),S=C(),_=N(),J=b(),K=t=>async function(...e){await t((this||J).api,...e)};export{S as describe,Q as expect,_ as runTestSuite,L as test,K as testSuite};
